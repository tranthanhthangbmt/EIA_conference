Tuy·ªát v·ªùi. Ch√∫ng ta s·∫Ω chuy·ªÉn sang tr·ª• c·ªôt th·ª© hai.
N·∫øu energy.html l√† ‚ÄúPh√≤ng Lab Sinh h·ªçc‚Äù ƒëo l∆∞·ªùng chi ph√≠, th√¨ emotion.html s·∫Ω l√† ‚ÄúM√°y Qu√©t T√¢m l√Ω h·ªçc‚Äù (Psychological Monitor). M·ª•c ti√™u l√† tr·ª±c quan h√≥a kh√°i ni·ªám tr·ª´u t∆∞·ª£ng ‚ÄúFlow‚Äù (D√≤ng ch·∫£y) v√† ch·ª©ng minh s·ª± v∆∞·ª£t tr·ªôi v·ªÅ s·ª©c kh·ªèe tinh th·∫ßn c·ªßa Bio-PKT.
ƒê√¢y l√† chi ti·∫øt tri·ªÉn khai cho Tr·ª• c·ªôt T√¢m l√Ω h·ªçc.

1. C∆° s·ªü Khoa h·ªçc (The Scientific Rationale)
ƒê·ªÉ tr·∫£ l·ªùi RQ2 (T·ªëi ∆∞u h√≥a tr·∫°ng th√°i t√¢m l√Ω), ch√∫ng ta c·∫ßn hi·ªán th·ª±c h√≥a 3 kh√°i ni·ªám:
1. K√™nh D√≤ng ch·∫£y (The Flow Channel):
o Theo Mihaly Csikszentmihalyi, tr·∫°ng th√°i t·ªëi ∆∞u n·∫±m gi·ªØa Nh√†m ch√°n (Stress < 30) v√† Lo √¢u (Stress > 70).
o Ch√∫ng ta s·∫Ω v·∫Ω m·ªôt ‚ÄúV√πng Xanh‚Äù tr√™n bi·ªÉu ƒë·ªì. Bio-PKT ph·∫£i ‚Äúl∆∞·ªõt‚Äù trong v√πng n√†y, c√≤n EFA s·∫Ω dao ƒë·ªông c·ª±c ƒëoan ra ngo√†i.
2. Qu√°n t√≠nh C·∫£m x√∫c (Emotional Inertia/Hysteresis):
o Gi·∫£ thuy·∫øt: Khi m·ªôt ng∆∞·ªùi b·ªã Stress c·ª±c ƒë·ªô (Burnout), h·ªç kh√¥ng th·ªÉ vui v·∫ª l·∫°i ngay l·∫≠p t·ª©c d√π ƒë√£ ng·ª´ng l√†m vi·ªác.
o EFA: B·ªã m·∫Øc k·∫πt trong v√πng Stress cao l√¢u h∆°n (ƒë·ªô tr·ªÖ l·ªõn).
o Bio-PKT: C√≥ kh·∫£ nƒÉng ph·ª•c h·ªìi ƒë√†n h·ªìi (Resilience).
3. Ch·ªâ s·ªë ·ªîn ƒë·ªãnh T√¢m l√Ω (Psychological Stability Index - PSI):
o ƒêo l∆∞·ªùng b·∫±ng ƒë·ªô l·ªách chu·∫©n ( œÉ ) c·ªßa Stress. œÉ c√†ng nh·ªè, t√¢m l√Ω c√†ng v·ªØng.

2. C·∫≠p nh·∫≠t Giao di·ªán: emotion.html
Ch√∫ng ta thay th·∫ø n·ªôi dung th·∫ª <body> b·∫±ng c·∫•u tr√∫c Dashboard t·∫≠p trung v√†o bi·ªÉu ƒë·ªì d√≤ng ch·∫£y.
<div class="container-emotion">
    <h1>üß† Psychological Dynamics (Tr·ª• c·ªôt T√¢m l√Ω)</h1>
    
    <div class="psycho-stats">
        <div class="psycho-card efa-style">
            <h3>EFA (Greedy)</h3>
            <div class="big-stat" id="efa-psi">---</div>
            <div class="sub-stat">Instability Index (œÉ)</div>
            <div class="status-badge" id="efa-state-badge">NORMAL</div>
            <div class="time-in-zone">Time in Anxiety: <span id="efa-anxiety-time">0</span>h</div>
        </div>

        <div class="psycho-card bio-style">
            <h3>Bio-PKT (Ours)</h3>
            <div class="big-stat" id="bio-psi">---</div>
            <div class="sub-stat">Stability Index (œÉ)</div>
            <div class="status-badge" id="bio-state-badge">FLOW</div>
            <div class="time-in-zone">Time in Flow: <span id="bio-flow-time">0</span>h</div>
        </div>
    </div>

    <div class="flow-chart-section">
        <h3>üåä The Flow Channel Visualization</h3>
        <p class="scientific-note">
            *V√πng m√†u xanh l√° m·ªù l√† "V√πng Flow" (Optimal Zone). 
            H√£y quan s√°t Bio-PKT (Xanh) dao ƒë·ªông nh·∫π nh√†ng b√™n trong, trong khi EFA (ƒê·ªè) li√™n t·ª•c ph√° v·ª° tr·∫ßn "Lo √¢u" (Anxiety Ceiling).
        </p>
        <div class="canvas-container-wide">
            <canvas id="flowChart"></canvas>
        </div>
    </div>
</div>

3. C·∫≠p nh·∫≠t Logic: script_emotion.js
Ch√∫ng ta c·∫ßn code l·∫°i bi·ªÉu ƒë·ªì ƒë·ªÉ v·∫Ω ƒë∆∞·ª£c ‚ÄúC√°i bƒÉng m√†u xanh‚Äù (Flow Band) l√†m n·ªÅn, v√† th√™m logic qu√°n t√≠nh.
// --- C·∫§U H√åNH CHART "FLOW CHANNEL" ---
let flowCtx = document.getElementById('flowChart').getContext('2d');
let flowChart = new Chart(flowCtx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            // 1. Gi·ªõi h·∫°n tr√™n c·ªßa Flow (Stress = 70) - D√πng ƒë·ªÉ t√¥ m√†u n·ªÅn
            {
                label: 'Anxiety Threshold',
                data: [], 
                borderColor: 'rgba(0,0,0,0)', // ·∫®n ƒë∆∞·ªùng vi·ªÅn
                pointRadius: 0,
                fill: false
            },
            // 2. Gi·ªõi h·∫°n d∆∞·ªõi c·ªßa Flow (Stress = 30) - T√¥ m√†u l√™n gi·ªõi h·∫°n tr√™n
            {
                label: 'Flow Zone',
                data: [],
                borderColor: 'rgba(0,0,0,0)', // ·∫®n ƒë∆∞·ªùng vi·ªÅn
                backgroundColor: 'rgba(0, 255, 100, 0.15)', // M√ÄU XANH N·ªÄN (The Channel)
                fill: '-1', // Fill l√™n dataset tr∆∞·ªõc ƒë√≥ (Anxiety Threshold)
                pointRadius: 0
            },
            // 3. ƒê∆∞·ªùng Stress c·ªßa EFA
            {
                label: 'EFA Stress Trajectory',
                borderColor: '#ff4444',
                borderWidth: 2,
                data: [],
                tension: 0.3
            },
            // 4. ƒê∆∞·ªùng Stress c·ªßa Bio-PKT
            {
                label: 'Bio-PKT Stress Trajectory',
                borderColor: '#44cc44',
                borderWidth: 2,
                data: [],
                tension: 0.3
            }
        ]
    },
    options: {
        responsive: true,
        animation: false,
        scales: {
            y: {
                min: 0, max: 100,
                title: { display: true, text: 'Psychological Stress Level' }
            }
        },
        plugins: {
            legend: { position: 'top' }
        }
    }
});

// Bi·∫øn th·ªëng k√™
let efaStressHistory = [];
let bioStressHistory = [];
let efaAnxietyCount = 0;
let bioFlowCount = 0;

// H√†m t√≠nh ƒê·ªô l·ªách chu·∫©n (Standard Deviation) - Ch·ªâ s·ªë PSI
function calculateSD(arr) {
    if (arr.length < 2) return 0;
    let mean = arr.reduce((a, b) => a + b) / arr.length;
    let variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / arr.length;
    return Math.sqrt(variance);
}

// --- LOGIC QU√ÅN T√çNH C·∫¢M X√öC (EMOTIONAL INERTIA) ---
// Th√™m h√†m n√†y v√†o logic h·ªìi ph·ª•c trong step()
function applyEmotionalInertia(agent, agentName) {
    // N·∫øu ƒëang ngh·ªâ ng∆°i (Recovery), Stress kh√¥ng gi·∫£m tuy·∫øn t√≠nh
    if (agent.status === "RECOVERY" || agent.status === "BURNOUT") {
        let recoveryRate = 2.0; // T·ªëc ƒë·ªô h·ªìi ph·ª•c g·ªëc
        
        if (agentName === 'Greedy') {
            // EFA b·ªã "Sang ch·∫•n" (Trauma): Stress c√†ng cao, h·ªìi ph·ª•c c√†ng ch·∫≠m
            if (agent.stress > 80) recoveryRate = 0.5; // R·∫•t ch·∫≠m
            else if (agent.stress > 60) recoveryRate = 1.0;
        } else {
            // Bio-PKT c√≥ Resilience (S·ª©c b·ªÅn): H·ªìi ph·ª•c ·ªïn ƒë·ªãnh
            recoveryRate = 2.5; 
        }
        
        // Tr·∫£ v·ªÅ l∆∞·ª£ng Stress gi·∫£m ƒë∆∞·ª£c
        return recoveryRate;
    }
    return 0; // Kh√¥ng ngh·ªâ th√¨ kh√¥ng gi·∫£m
}

// --- C·∫¨P NH·∫¨T UI & DATA (G·ªçi trong v√≤ng l·∫∑p ch√≠nh) ---
function updateEmotionMetrics() {
    
    // 1. C·∫≠p nh·∫≠t d·ªØ li·ªáu cho Chart (Flow Channel Background)
    // Lu√¥n push gi√° tr·ªã c·ªë ƒë·ªãnh ƒë·ªÉ t·∫°o th√†nh c√°i bƒÉng d√†i v√¥ t·∫≠n
    flowChart.data.datasets[0].data.push(70); // Tr·∫ßn
    flowChart.data.datasets[1].data.push(30); // S√†n
    
    // Push d·ªØ li·ªáu th·ª±c
    flowChart.data.datasets[2].data.push(greedy.stress);
    flowChart.data.datasets[3].data.push(bio.stress);
    flowChart.data.labels.push(globalTime);

    // Gi·ªØ chart tr√¥i (Rolling window 60 steps)
    if (flowChart.data.labels.length > 60) {
        flowChart.data.labels.shift();
        flowChart.data.datasets.forEach(d => d.data.shift());
    }
    if (globalTime % 3 === 0) flowChart.update();

    // 2. T√≠nh to√°n Th·ªëng k√™ (PSI & Time in Zone)
    efaStressHistory.push(greedy.stress);
    bioStressHistory.push(bio.stress);
    
    // ƒê·∫øm gi·ªù
    if (greedy.stress > 70) efaAnxietyCount++;
    if (bio.stress >= 30 && bio.stress <= 70) bioFlowCount++;

    // T√≠nh PSI (Instability)
    let efaPSI = calculateSD(efaStressHistory.slice(-50)); // 50 b∆∞·ªõc g·∫ßn nh·∫•t
    let bioPSI = calculateSD(bioStressHistory.slice(-50));

    // Hi·ªÉn th·ªã s·ªë li·ªáu
    document.getElementById('efa-psi').innerText = efaPSI.toFixed(1);
    document.getElementById('bio-psi').innerText = bioPSI.toFixed(1);
    
    document.getElementById('efa-anxiety-time').innerText = efaAnxietyCount;
    document.getElementById('bio-flow-time').innerText = bioFlowCount;

    // C·∫≠p nh·∫≠t Badge tr·∫°ng th√°i
    let efaBadge = document.getElementById('efa-state-badge');
    if (greedy.stress > 80) { efaBadge.innerText = "PANIC"; efaBadge.className = "status-badge badge-panic"; }
    else if (greedy.stress < 20) { efaBadge.innerText = "BORED"; efaBadge.className = "status-badge badge-bored"; }
    else { efaBadge.innerText = "NORMAL"; efaBadge.className = "status-badge"; }

    let bioBadge = document.getElementById('bio-state-badge');
    if (bio.stress >= 30 && bio.stress <= 70) { bioBadge.innerText = "IN FLOW"; bioBadge.className = "status-badge badge-flow"; }
    else { bioBadge.innerText = "BALANCING"; bioBadge.className = "status-badge"; }
}

4. Style CSS (style_emotion.css)
Th√™m m√†u s·∫Øc ƒë·ªÉ ph√¢n bi·ªát r√µ c√°c tr·∫°ng th√°i t√¢m l√Ω.
.container-emotion {
    background: #121212;
    color: #e0e0e0;
    padding: 20px;
}

.psycho-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.psycho-card {
    flex: 1;
    background: #1e1e1e;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.efa-style { border-left: 5px solid #ff4444; }
.bio-style { border-left: 5px solid #44cc44; }

.big-stat {
    font-size: 3em;
    font-weight: 800;
    margin: 10px 0;
}
.efa-style .big-stat { color: #ff6666; } /* M√†u ƒë·ªè nh·∫°t cho s·ªë li·ªáu x·∫•u */
.bio-style .big-stat { color: #66ff66; } /* M√†u xanh nh·∫°t cho s·ªë li·ªáu t·ªët */

.status-badge {
    display: inline-block;
    padding: 5px 15px;
    border-radius: 20px;
    background: #333;
    font-weight: bold;
    margin-bottom: 10px;
}

.badge-panic { background: #cc0000; color: white; animation: pulse 1s infinite; }
.badge-flow { background: #8e44ad; color: white; box-shadow: 0 0 10px #8e44ad; }
.badge-bored { background: #7f8c8d; color: white; }

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.canvas-container-wide {
    background: #1a1a1a;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #333;
    height: 350px; /* Cao h∆°n ƒë·ªÉ nh√¨n r√µ s√≥ng */
}

5. √ù nghƒ©a Khoa h·ªçc khi ch·∫°y (D√†nh cho B√†i b√°o)
Sau khi t√≠ch h·ª£p xong, ƒë√¢y l√† nh·ªØng g√¨ b·∫°n s·∫Ω vi·∫øt trong ph·∫ßn ‚ÄúPsychological Impact Analysis‚Äù:
1. Minh ch·ª©ng v·ªÅ ‚ÄúK√™nh D√≤ng ch·∫£y‚Äù (The Flow Channel Proof):
o Nh√¨n v√†o bi·ªÉu ƒë·ªì flowChart: ƒê∆∞·ªùng m√†u xanh (Bio-PKT) tr√¥ng gi·ªëng nh∆∞ m·ªôt s√≥ng sin ƒëi·ªÅu h√≤a (harmonic wave) n·∫±m g·ªçn trong v√πng n·ªÅn xanh l√°.
o ƒê∆∞·ªùng m√†u ƒë·ªè (EFA) gi·ªëng nh∆∞ ƒë·ªôt bi·∫øn ƒë·ªãa ch·∫•n (seismic spikes), li√™n t·ª•c ƒë√¢m th·ªßng tr·∫ßn ‚ÄúAnxiety Threshold‚Äù.
o K·∫øt lu·∫≠n: Bio-PKT duy tr√¨ ƒë∆∞·ª£c tr·∫°ng th√°i t√¢m l√Ω b·ªÅn v·ªØng (Psychological Homeostasis).
2. Ch·ªâ s·ªë B·∫•t ·ªïn ƒë·ªãnh (PSI Metric):
o S·ªë li·ªáu Instability Index (œÉ) c·ªßa EFA s·∫Ω r·∫•t cao (v√≠ d·ª•: 25.4), trong khi Bio-PKT th·∫•p (v√≠ d·ª•: 8.2).
o Lu·∫≠n ƒëi·ªÉm: Ph∆∞∆°ng sai th·∫•p ƒë·ªìng nghƒ©a v·ªõi kh·∫£ nƒÉng d·ª± ƒëo√°n cao (Predictability) ‚Äì m·ªôt y·∫øu t·ªë then ch·ªët cho gi√°o d·ª•c c√° nh√¢n h√≥a an to√†n.
3. Qu√°n t√≠nh (Inertia) v√† H·∫≠u qu·∫£:
o Nh·ªù logic applyEmotionalInertia, b·∫°n s·∫Ω th·∫•y khi EFA ch·∫°m ƒë·ªânh 100 v√† b·∫Øt ƒë·∫ßu ngh·ªâ, ƒë∆∞·ªùng ƒë·ªè ƒëi xu·ªëng r·∫•t ch·∫≠m (d·ªëc tho·∫£i). ƒêi·ªÅu n√†y m√¥ ph·ªèng th·ª±c t·∫ø: ‚ÄúM·ªôt k·ª≥ ngh·ªâ ng·∫Øn kh√¥ng th·ªÉ ch·ªØa l√†nh s·ª± ki·ªát qu·ªá d√†i h·∫°n‚Äù.
V·ªõi emotion.html n√†y, b·∫°n ƒë√£ n√¢ng c·∫•p b√†i b√°o t·ª´ ‚ÄúT·ªëi ∆∞u ƒëi·ªÉm s·ªë‚Äù sang ‚ÄúT·ªëi ∆∞u tr·∫£i nghi·ªám ng∆∞·ªùi h·ªçc‚Äù (Learner Experience Optimization - LXO).
