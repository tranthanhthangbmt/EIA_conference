<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-PKT: Energy Dynamics (Scientific)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <aside class="sidebar">
            <div class="header">
                <h2>Bio-PKT Energy Dynamics</h2>
                <p>Scientific Simulation (v2C Restored)</p>
            </div>

            <!-- Navigation back to Dashboard -->
            <div class="control-group">
                <button onclick="window.location.href='index.html'" class="btn-run"
                    style="background: #475569; margin-bottom: 5px;">
                    &larr; Back to Dashboard
                </button>
                <button onclick="window.location.href='emotion.html'" class="btn-run"
                    style="background: linear-gradient(135deg, #ec4899, #8b5cf6);">
                    Go to Empathic AI (v9.4) &rarr;
                </button>
            </div>

            <div class="control-group">
                <label>Energy Profile</label>
                <div class="input-wrap">
                    <span>High Load Drain (&alpha;<sub>high</sub>)</span>
                    <input type="range" id="alphaHigh" min="10" max="30" value="18"
                        oninput="updateVal('valAlphaHigh', this.value)">
                    <span id="valAlphaHigh" class="val-display">18%</span>
                </div>
                <div class="input-wrap">
                    <span>Recovery Rate (&beta;)</span>
                    <input type="range" id="recovRate" min="5" max="25" value="15"
                        oninput="updateVal('valRecov', this.value)">
                    <span id="valRecov" class="val-display">15%</span>
                </div>
            </div>

            <div class="control-group warning-zone">
                <label>Realism & Constraints</label>

                <div class="input-wrap">
                    <span>Forgetting Rate (&delta;)</span>
                    <input type="range" id="decayRate" min="0" max="20" value="5" step="1"
                        oninput="updateVal('valDecay', this.value/1000)">
                    <span id="valDecay" class="val-display">0.005</span>
                    <p class="small-note">*Knowledge decays over time. Burnout accelerates this by 3x.</p>
                </div>

                <div class="input-wrap">
                    <span>Switching Cost</span>
                    <input type="range" id="switchCost" min="0" max="10" value="2"
                        oninput="updateVal('valSwitch', this.value)">
                    <span id="valSwitch" class="val-display">2%</span>
                </div>
            </div>

            <div class="control-group mpc-zone">
                <label>MPC Controller</label>
                <div class="input-wrap">
                    <span>Prediction Horizon (H)</span>
                    <input type="range" id="mpcHorizon" min="1" max="5" value="3"
                        oninput="updateVal('valHorizon', this.value)">
                    <span id="valHorizon" class="val-display">3 hrs</span>
                </div>
                <div class="toggle-wrap">
                    <span>Non-linear Fatigue</span>
                    <label class="switch">
                        <input type="checkbox" id="nonLinearToggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <div class="control-group warning-zone">
                <label>Reality Gap & Autonomy</label>

                <div class="input-wrap">
                    <span>Model Mismatch (Sai số)</span>
                    <input type="range" id="mismatch" min="0" max="50" value="20"
                        oninput="updateVal('valMis', this.value)">
                    <span id="valMis" class="val-display">20%</span>
                    <p class="small-note">*Real world is harder than MPC thinks.</p>
                </div>

                <div class="toggle-wrap">
                    <span>Dynamic Efficiency (&eta;)</span>
                    <label class="switch">
                        <input type="checkbox" id="efficiencyToggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>

                <div class="input-wrap">
                    <span>Compliance Rate (Độ tuân thủ)</span>
                    <input type="range" id="compliance" min="50" max="100" value="100"
                        oninput="updateVal('valComp', this.value)">
                    <span id="valComp" class="val-display">100%</span>
                    <p class="small-note">*Will students obey the AI?</p>
                </div>
            </div>

            <div class="control-group">
                <label>Experiment Mode</label>
                <div class="button-group" style="display: flex; gap: 10px;">
                    <button onclick="runSimulation()" class="btn-run" style="flex:1;">Single Run</button>
                    <button onclick="runMonteCarlo()" class="btn-run btn-monte"
                        style="flex:1; background: linear-gradient(135deg, #6366f1, #8b5cf6);">Monte Carlo
                        (N=50)</button>
                </div>
                <div style="margin-top: 5px; text-align: center;">
                    <button onclick="runSensitivityAnalysis()"
                        style="background:none; border:none; color: #818cf8; cursor: pointer; text-decoration: underline; font-size: 0.85rem;">Run
                        Parameter Sensitivity Test</button>
                </div>
                <p id="mcStatus" class="small-note" style="margin-top:5px; color:#a5b4fc; min-height: 1.2em;"></p>
            </div>
        </aside>

        <main class="main-content">
            <!-- NEW: Metabolic Vitals Panel (from update_1.txt) -->
            <div class="vitals-panel" style="margin-bottom: 20px; display:flex; gap:20px;">
                <div class="agent-box efa-box"
                    style="flex:1; background:#2d2d2d; padding:15px; border-radius:8px; border-top:4px solid #ff4444;">
                    <h2 style="margin:0 0 10px 0; font-size:1.1em;">HPA (Greedy) Vitals</h2>
                    <div class="meter-label" style="font-size:0.8em; color:#aaa;">Energy Reserves</div>
                    <div class="progress-bg" style="background:#444; height:10px; border-radius:5px; overflow:hidden;">
                        <div id="efa-energy-bar" class="progress-fill red"
                            style="width:100%; height:100%; background:#ff4444;"></div>
                    </div>
                    <div class="metric-row"
                        style="display:flex; justify-content:space-between; margin-top:10px; border-bottom:1px solid #444; padding-bottom:5px;">
                        <span>Metabolic Cost:</span>
                        <span style="font-weight:bold; color:#ff4444;"><span id="efa-metabolic">---</span> J/pt</span>
                    </div>
                    <div class="metric-row" style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span>Energy Debt:</span>
                        <span style="font-weight:bold; color:#ff4444;"><span id="efa-debt">0</span> units</span>
                    </div>
                </div>

                <div class="agent-box bio-box"
                    style="flex:1; background:#2d2d2d; padding:15px; border-radius:8px; border-top:4px solid #44cc44;">
                    <h2 style="margin:0 0 10px 0; font-size:1.1em;">Bio-PKT (Ours) Vitals</h2>
                    <div class="meter-label" style="font-size:0.8em; color:#aaa;">Energy Reserves</div>
                    <div class="progress-bg" style="background:#444; height:10px; border-radius:5px; overflow:hidden;">
                        <div id="bio-energy-bar" class="progress-fill green"
                            style="width:100%; height:100%; background:#44cc44;"></div>
                    </div>
                    <div class="metric-row"
                        style="display:flex; justify-content:space-between; margin-top:10px; border-bottom:1px solid #444; padding-bottom:5px;">
                        <span>Metabolic Cost:</span>
                        <span style="font-weight:bold; color:#44cc44;"><span id="bio-metabolic">---</span> J/pt</span>
                    </div>
                    <div class="metric-row" style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span>Energy Debt:</span>
                        <span style="font-weight:bold; color:#44cc44;"><span id="bio-debt">0</span> units</span>
                    </div>
                </div>
            </div>

            <!-- Existing Stats (Summary) -->
            <div class="stats-panel" style="margin-bottom: 20px;">
                <div class="card stat-card red">
                    <h3>Greedy</h3>
                    <p>Net Knowledge: <span id="scoreGreedy">0</span></p>
                    <p>Burnouts: <span id="burnGreedy">0</span></p>
                </div>
                <div class="card stat-card yellow">
                    <h3>Fixed (Pomodoro)</h3>
                    <p>Net Knowledge: <span id="scoreFixed">0</span></p>
                    <p>Burnouts: <span id="burnFixed">0</span></p>
                </div>
                <div class="card stat-card green">
                    <h3>Bio-PKT (MPC)</h3>
                    <p>Net Knowledge: <span id="scoreBio">0</span></p>
                    <p>Burnouts: <span id="burnBio">0</span></p>
                </div>
                <div class="card stat-card improvement">
                    <h3>Superiority</h3>
                    <p id="improvementVal">+0%</p>
                    <small>vs. Fixed Strategy</small>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-wrapper">
                    <h4>Fig 4a. Energy Optimization (E<sub>t</sub>)</h4>
                    <div class="canvas-container">
                        <canvas id="energyChart"></canvas>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <h4>Fig 4b. Cumulative Knowledge Gain</h4>
                    <div class="canvas-container">
                        <canvas id="knowledgeChart"></canvas>
                    </div>
                </div>
                <!-- NEW CHART -->
                <div class="chart-wrapper">
                    <h4>Fig 4c. Cost of Learning (Joules per Point)</h4>
                    <p class="scientific-note" style="font-size:0.8em; color:#aaa; margin-top:-5px;">*Lower is better.
                        High spikes = Inefficient Stress.</p>
                    <div class="canvas-container">
                        <canvas id="metabolicChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Independent Script for Energy Simulation -->
    <script src="script_energy.js"></script>
    <script>
        function updateVal(id, val) {
            let displayVal = val;
            if (id === 'valDecay') displayVal = (val / 1000).toFixed(3);
            else if (id === 'valHorizon') displayVal = val + ' hrs';
            else displayVal += '%';

            document.getElementById(id).innerText = displayVal;
            // Debounce or just run
            setTimeout(runSimulation, 50);
        }
    </script>
    <script src="navbar.js"></script>
</body>

</html>